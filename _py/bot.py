import telebot
import pytesseract
import shutil
from _py import sql
from _py import DataProcessor as DP
from telebot import types
try: from PIL import Image
except ImportError: import Image


pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'
bot = telebot.TeleBot('6473764124:AAHx0vL35z5gK1r4PElgagK5W8KKZWLXknc')


def ocr_core(filename): 
    return pytesseract.image_to_string(Image.open(filename), lang='rus+eng')  


def save_image(f_name, d_name):
    shutil.copyfile(f_name, d_name + "img" + sql.lastIdInDb() + ".jpg") #

def create_archive(f_name, d_name):
    shutil.make_archive(f_name, 'zip', d_name)

def start():
    f_name = "./image.jpg" # –ò–º—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞-–∫–∞—Ä—Ç–∏–Ω–∫–∏
    d_name = "./img/" # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–æ–∫
    out_file = "./out.xlsx" # –ò–º—è Excel —Ñ–∞–π–ª–∞
    archive_name = "./out" # –ò–º—è –∞—Ä—Ö–∏–≤–∞ —Å—Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏
    archive_dir = d_name[:] # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∞—Ä—Ö–∏–≤–∞ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏


    @bot.message_handler(commands=['start'])
    def start(message):
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
        btn1 = types.KeyboardButton("üëã –ü–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è")
        markup.add(btn1)
        bot.send_message(message.from_user.id, "üëã –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –±–æ—Ç-–ø–æ–º–æ—à–Ω–∏–∫!", reply_markup=markup)


    @bot.message_handler(content_types=['text'])
    def get_text_messages(message):
        if message.text == 'üëã –ü–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è':
            markup = types.ReplyKeyboardMarkup(resize_keyboard=True) #—Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
            btn1 = types.KeyboardButton('–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º?')
            btn2 = types.KeyboardButton('–ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ-–∞—Ä—Ö–∏–≤ –∫–∞—Ä—Ç–æ—á–µ–∫')
            btn3 = types.KeyboardButton('–ü–æ–ª—É—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∫–∞—Ä—Ç–æ—á–µ–∫')
            markup.add(btn1, btn2, btn3)
            bot.send_message(message.from_user.id, '‚ùì –ó–∞–¥–∞–π—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å –≤–æ–ø—Ä–æ—Å', reply_markup=markup) #–æ—Ç–≤–µ—Ç –±–æ—Ç–∞
        elif message.text == '–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º?':
            bot.send_message(message.from_user.id, '*–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ*', parse_mode='Markdown')
        elif message.text == '–ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ-–∞—Ä—Ö–∏–≤ –∫–∞—Ä—Ç–æ—á–µ–∫':
            create_archive(archive_name, archive_dir) # –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –∫–∞—Ä—Ç–∏–Ω–æ–∫
            bot.send_document(message.from_user.id, open(archive_name + ".zip", "rb")) # –û—Ç–ø—Ä–∞–≤–∫–∞ zip —Ñ–∞–π–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 
            bot.send_message(message.from_user.id, f'–§–∞–π–ª {archive_name.lstrip("./")}.zip - –∞—Ä—Ö–∏–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Ñ–æ—Ç–æ –≤—Å–µ—Ö –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤–∏–∑–∏—Ç–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫.', parse_mode='Markdown')
        elif message.text == '–ü–æ–ª—É—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∫–∞—Ä—Ç–æ—á–µ–∫':
            sql.excelDb(out_file) # –≠–∫—Å–ø–æ—Ä—Ç –ë–î –≤ Excel
            bot.send_document(message.from_user.id, open(out_file, "rb")) # –û—Ç–ø—Ä–∞–≤–∫–∞ Excel —Ñ–∞–π–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é 
            bot.send_message(message.from_user.id, f'–§–∞–π–ª {out_file.lstrip("./")} - —Ç–∞–±–ª–∏—Ü–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è –≤—Å–µ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏.', parse_mode='Markdown')


    @bot.message_handler(content_types=['photo'])
    def photo(message):
        fileID = message.photo[-1].file_id
        file_info = bot.get_file(fileID)
        downloaded_file = bot.download_file(file_info.file_path)
        with open(f_name, 'wb') as new_file:
            new_file.write(downloaded_file)
        sql.createDb() # –°–æ–∑–¥–∞–Ω–∏–µ –ë–î, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
        raw_data = ocr_core(f_name) # –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–ª—É—á–µ–Ω–Ω–Ω—ã–µ –∏–∑ OCR
        dp = DP.DataProcessor(raw_data)
        bot.send_message(message.from_user.id, text=raw_data)

        ```test```
        markup = types.InlineKeyboardMarkup()
        button1 = types.InlineKeyboardButton("–°–∞–π—Ç –•–∞–±—Ä", url='https://habr.com/ru/all/')
        markup.add(button1)
        bot.send_message(message.chat.id, raw_data.format(message.from_user), reply_markup=markup)
        ```test```
        
        data = dp.dataExtract()
        # data = ("1", "1", "1", "1", "1", "1", "1") # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        sql.insertDb(data) # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
        save_image(f_name, d_name) # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏
        
    
    bot.polling(none_stop=False, interval=1) #–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ —á–∞—Å—Ç—å
